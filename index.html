<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Wallet</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/ca9a253b70.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>
    <div id="app">
        <!-- „É°„Ç§„É≥ÁîªÈù¢ÔºàQR„Ç≥„Éº„Éâ‰∏ÄË¶ßÔºâ -->
        <div v-if="currentView === 'main'" class="container">
            <header>
                <h1>QR Wallet</h1>
            </header>

            <main>
                <!-- QR„Ç≥„Éº„Éâ‰∏ÄË¶ß -->
                <div v-if="qrHistory.length > 0" class="qr-grid">
                    <div v-for="(item, index) in qrHistory" :key="index" class="qr-card">
                        <button @click.stop="deleteQRFromList(index)" class="btn-delete-card">√ó</button>
                        <div class="qr-card-content" @click="openQRDetail(index)">
                            <div class="qr-preview" ref="qrPreview">
                                <!-- QR„Ç≥„Éº„Éâ„Éó„É¨„Éì„É•„Éº -->
                            </div>
                            <div class="qr-text">
                                <i :class="formatDisplayText(item).icon"></i>
                                <span>{{ truncateText(formatDisplayText(item).text, 25) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Á©∫„ÅÆÁä∂ÊÖã -->
                <div v-else class="empty-state">
                    <div class="empty-icon">üì±</div>
                    <h2>QR„Ç≥„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h2>
                    <p>„ÄåAdd QR code„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶QR„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>

                <!-- Add QR code „Éú„Çø„É≥ -->
                <div class="add-qr-section">
                    <button @click="switchToAddView" class="btn btn-primary btn-large">
                        <span class="btn-icon">+</span>
                        Add QR code
                    </button>
                </div>

                <!-- ËøΩÂä†Ê©üËÉΩ„Éú„Çø„É≥ -->
                <div class="additional-actions">
                    <button @click="addBookmark" class="btn btn-subtle">
                        <i class="fa-regular fa-bookmark"></i>
                        „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØËøΩÂä†
                    </button>
                    <button @click="createNewWallet" class="btn btn-subtle">
                        <i class="fa-solid fa-plus"></i>
                        Êñ∞„Åó„ÅÑ„Ç¶„Ç©„É¨„ÉÉ„Éà
                    </button>
                </div>
            </main>
        </div>

        <!-- QRËøΩÂä†ÁîªÈù¢ -->
        <div v-else-if="currentView === 'add'" class="container">
            <header>
                <div class="header-with-back">
                    <button @click="switchToMainView" class="btn btn-back">‚Üê Êàª„Çã</button>
                    <h1>QR„Ç≥„Éº„ÉâËøΩÂä†</h1>
                </div>
            </header>

            <main>
                <div class="app-container">
                    <!-- „Ç´„É°„É©Ë™≠„ÅøÂèñ„Çä„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <section class="camera-section">
                        <div class="section-header" @click="toggleCameraSection">
                            <h2>QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä</h2>
                            <span class="toggle-icon">{{ showCameraSection ? '‚ñº' : '‚ñ∂' }}</span>
                        </div>
                        <div v-if="showCameraSection" class="section-content">
                            <div class="camera-container">
                                <video ref="video" autoplay muted playsinline></video>
                                <canvas ref="canvas" style="display: none;"></canvas>
                                <div class="camera-overlay">
                                    <div class="scan-area"></div>
                                </div>
                            </div>
                            <div class="camera-controls">
                                <button @click="startCamera" class="btn btn-primary"
                                    :disabled="isCameraActive">„Ç´„É°„É©ÈñãÂßã</button>
                                <button @click="stopCamera" class="btn btn-secondary"
                                    :disabled="!isCameraActive">„Ç´„É°„É©ÂÅúÊ≠¢</button>
                            </div>
                            <div class="scan-result">
                                <p>{{ scanStatus }}</p>
                                <div v-if="scannedData" class="scanned-data">
                                    <h3>Ë™≠„ÅøÂèñ„ÇäÁµêÊûú:</h3>
                                    <p>{{ scannedData }}</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <section class="generator-section">
                        <h2>QR„Ç≥„Éº„ÉâÁîüÊàê</h2>
                        <div class="input-container">
                            <textarea v-model="qrInputText" placeholder="QR„Ç≥„Éº„Éâ„Å´Â§âÊèõ„Åó„Åü„ÅÑ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                                @input="debouncedRegenerate"></textarea>
                            <div class="input-buttons">
                                <button @click="generateQRCode" class="btn btn-primary">QR„Ç≥„Éº„ÉâÁîüÊàê</button>
                                <button @click="addToWallet" class="btn btn-success">„Ç¶„Ç©„É¨„ÉÉ„Éà„Å´ÁôªÈå≤</button>
                            </div>
                        </div>

                        <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„Ç™„Éó„Ç∑„Éß„É≥ -->
                        <div v-if="showQRGenerator" class="qr-options">
                            <h3>ÁîüÊàê„Ç™„Éó„Ç∑„Éß„É≥</h3>
                            <div class="options-grid">
                                <div class="option-group">
                                    <label for="qrSize">„Çµ„Ç§„Ç∫:</label>
                                    <select v-model="qrOptions.size" @change="regenerateQR">
                                        <option value="128">128px</option>
                                        <option value="200">200px</option>
                                        <option value="256">256px</option>
                                        <option value="320">320px</option>
                                        <option value="400">400px</option>
                                    </select>
                                </div>

                                <div class="option-group">
                                    <label for="qrMargin">„Éû„Éº„Ç∏„É≥:</label>
                                    <select v-model="qrOptions.margin" @change="regenerateQR">
                                        <option value="0">„Å™„Åó</option>
                                        <option value="1">Â∞è</option>
                                        <option value="2">Ê®ôÊ∫ñ</option>
                                        <option value="4">Â§ß</option>
                                    </select>
                                </div>

                                <div class="option-group">
                                    <label for="qrErrorLevel">„Ç®„É©„ÉºË®ÇÊ≠£„É¨„Éô„É´:</label>
                                    <select v-model="qrOptions.errorLevel" @change="regenerateQR">
                                        <option value="L">L (7%)</option>
                                        <option value="M">M (15%)</option>
                                        <option value="Q">Q (25%)</option>
                                        <option value="H">H (30%)</option>
                                    </select>
                                </div>

                                <div class="option-group">
                                    <label for="qrDarkColor">ÂâçÊôØËâ≤:</label>
                                    <input type="color" v-model="qrOptions.darkColor" @change="regenerateQR">
                                </div>

                                <div class="option-group">
                                    <label for="qrLightColor">ËÉåÊôØËâ≤:</label>
                                    <input type="color" v-model="qrOptions.lightColor" @change="regenerateQR">
                                </div>
                            </div>
                        </div>

                        <div v-if="showQRGenerator" class="qr-display">
                            <div ref="qrCode" class="qr-code-container"></div>
                            <div class="qr-controls">
                                <button @click="downloadQR" class="btn btn-secondary"
                                    :disabled="!hasGeneratedQR">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                                <button @click="copyQR" class="btn btn-secondary"
                                    :disabled="!hasGeneratedQR">„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- QRË©≥Á¥∞ÁîªÈù¢Ôºà„É¢„Éº„ÉÄ„É´Ôºâ -->
        <div v-if="showQRDetail" class="modal-overlay" @click="closeQRDetail">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h2>QR„Ç≥„Éº„ÉâË©≥Á¥∞</h2>
                    <button @click="closeQRDetail" class="btn btn-close">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="qr-detail-content">
                        <div class="qr-detail-qr">
                            <div ref="qrDetailCode" class="qr-detail-container"></div>
                        </div>
                        <div class="qr-detail-text">
                            <h3>„ÉÜ„Ç≠„Çπ„ÉàÂÜÖÂÆπ</h3>
                            <p>{{ selectedQRData }}</p>
                        </div>
                        <div class="qr-detail-options">
                            <h3>ÁîüÊàê„Ç™„Éó„Ç∑„Éß„É≥</h3>
                            <div class="options-grid">
                                <div class="option-group">
                                    <label>„Çµ„Ç§„Ç∫:</label>
                                    <select v-model="detailQROptions.size" @change="regenerateDetailQR">
                                        <option value="128">128px</option>
                                        <option value="200">200px</option>
                                        <option value="256">256px</option>
                                        <option value="320">320px</option>
                                        <option value="400">400px</option>
                                    </select>
                                </div>

                                <div class="option-group">
                                    <label>„Éû„Éº„Ç∏„É≥:</label>
                                    <select v-model="detailQROptions.margin" @change="regenerateDetailQR">
                                        <option value="0">„Å™„Åó</option>
                                        <option value="1">Â∞è</option>
                                        <option value="2">Ê®ôÊ∫ñ</option>
                                        <option value="4">Â§ß</option>
                                    </select>
                                </div>

                                <div class="option-group">
                                    <label>„Ç®„É©„ÉºË®ÇÊ≠£„É¨„Éô„É´:</label>
                                    <select v-model="detailQROptions.errorLevel" @change="regenerateDetailQR">
                                        <option value="L">L (7%)</option>
                                        <option value="M">M (15%)</option>
                                        <option value="Q">Q (25%)</option>
                                        <option value="H">H (30%)</option>
                                    </select>
                                </div>

                                <div class="option-group">
                                    <label>ÂâçÊôØËâ≤:</label>
                                    <input type="color" v-model="detailQROptions.darkColor"
                                        @change="regenerateDetailQR">
                                </div>

                                <div class="option-group">
                                    <label>ËÉåÊôØËâ≤:</label>
                                    <input type="color" v-model="detailQROptions.lightColor"
                                        @change="regenerateDetailQR">
                                </div>
                            </div>
                        </div>
                        <div class="qr-detail-actions">
                            <button @click="downloadDetailQR" class="btn btn-primary">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                            <button @click="copyDetailQR" class="btn btn-secondary">„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
                            <button @click="deleteQR" class="btn btn-danger">ÂâäÈô§</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
        <div v-if="showDeleteConfirm" class="modal-overlay" @click="cancelDelete">
            <div class="modal-content modal-small" @click.stop>
                <div class="modal-header">
                    <h2>ÂâäÈô§Á¢∫Ë™ç</h2>
                </div>
                <div class="modal-body">
                    <div class="delete-confirm-content">
                        <div class="delete-confirm-icon">‚ö†Ô∏è</div>
                        <p class="delete-confirm-message">„Åì„ÅÆQR„Ç≥„Éº„Éâ„ÅÆÁôªÈå≤„ÇíËß£Èô§„Åó„Å¶„Çà„ÅÑ„Åß„Åô„ÅãÔºü</p>
                        <div class="delete-confirm-text">
                            <strong>ÂÜÖÂÆπ:</strong> {{ qrHistory[deleteTargetIndex] }}
                        </div>
                        <div class="delete-confirm-actions">
                            <button @click="confirmDelete" class="btn btn-danger">ÂâäÈô§</button>
                            <button @click="cancelDelete" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 USAMI Kenta</p>
            <div class="footer-trademark">
                <p>‚Äª QR„Ç≥„Éº„Éâ„ÅØÊ†™Âºè‰ºöÁ§æ„Éá„É≥„ÇΩ„Éº„Ç¶„Çß„Éº„Éñ„ÅÆÁôªÈå≤ÂïÜÊ®ô„Åß„Åô„ÄÇ</p>
                <p>‚Äª QR Code is a registered trademark of DENSO WAVE INCORPORATED.</p>
            </div>
        </footer>
    </div>

    <script src="app.js"></script>
    <script>
        // ÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÁî®„ÅÆ„Çπ„ÇØ„É™„Éó„ÉàÁÆ°ÁêÜ
        window.lazyScripts = {
            jsQR: {
                url: 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js',
                loaded: false,
                promise: null
            },
            qrcode: {
                url: 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.js',
                loaded: false,
                promise: null
            }
        };

        // „Çπ„ÇØ„É™„Éó„Éà„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÈñ¢Êï∞
        function loadScript(scriptName) {
            const script = window.lazyScripts[scriptName];
            if (!script) {
                return Promise.reject(new Error(`Unknown script: ${scriptName}`));
            }

            if (script.loaded) {
                return Promise.resolve();
            }

            if (script.promise) {
                return script.promise;
            }

            script.promise = new Promise((resolve, reject) => {
                const scriptElement = document.createElement('script');
                scriptElement.src = script.url;
                scriptElement.onload = () => {
                    script.loaded = true;
                    resolve();
                };
                scriptElement.onerror = () => {
                    reject(new Error(`Failed to load ${scriptName}`));
                };
                document.head.appendChild(scriptElement);
            });

            return script.promise;
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
        window.loadScript = loadScript;
    </script>
</body>

</html>